<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.226">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>The PyTorch Book - 10&nbsp; Modeling pipeline with fastai’s High-Level API</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../nbs/11_MNISTusingFastaiMidLevelAPI.html" rel="next">
<link href="../nbs/9_IntroductionToFastAI.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-Q8J05XS7Q7"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-Q8J05XS7Q7', { 'anonymize_ip': true});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Modeling pipeline with fastai’s High-Level API</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">The PyTorch Book</a> 
        <div class="sidebar-tools-main">
    <a href="" title="Share" id="sidebar-tool-dropdown-0" class="sidebar-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-share"></i></a>
    <ul class="dropdown-menu" aria-labelledby="sidebar-tool-dropdown-0">
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=|url|">
            <i class="bi bi-bi-linkedin pe-1"></i>
          LinkedIn
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
            <i class="bi bi-bi-twitter pe-1"></i>
          Twitter
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
            <i class="bi bi-bi-facebook pe-1"></i>
          Facebook
          </a>
        </li>
    </ul>
  <a href="" class="quarto-color-scheme-toggle sidebar-tool" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">Preface</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">PyTorch basics</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nbs/1_pytorch_intro.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">PyTorch Introduction and Installation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nbs/2_pytorch_tensors.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Tensors</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nbs/3_broadcasting.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Broadcasting</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nbs/4_autograd.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Automatic Differentiation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nbs/5_datasets.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Datasets and Dataloaders</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nbs/6_optimizers.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Optimizers and Learning loops</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nbs/7_defining_models.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Defining Model</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nbs/8_NeuralNetworks.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Modeling pipeline with Neural networks</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">fastai</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nbs/9_IntroductionToFastAI.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Introduction to fastai</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nbs/10_MNISTusingFastaiHighLevelAPI.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Modeling pipeline with fastai’s High-Level API</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nbs/11_MNISTusingFastaiMidLevelAPI.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Modeling pipeline with fastai’s Mid-Level API (draft)</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#download-data" id="toc-download-data" class="nav-link active" data-scroll-target="#download-data"><span class="toc-section-number">10.1</span>  Download data</a></li>
  <li><a href="#creating-dataloaders" id="toc-creating-dataloaders" class="nav-link" data-scroll-target="#creating-dataloaders"><span class="toc-section-number">10.2</span>  Creating DataLoaders</a></li>
  <li><a href="#creating-a-learner" id="toc-creating-a-learner" class="nav-link" data-scroll-target="#creating-a-learner"><span class="toc-section-number">10.3</span>  Creating a learner</a></li>
  <li><a href="#training-the-model" id="toc-training-the-model" class="nav-link" data-scroll-target="#training-the-model"><span class="toc-section-number">10.4</span>  Training the model</a></li>
  <li><a href="#analyzing-model-performance" id="toc-analyzing-model-performance" class="nav-link" data-scroll-target="#analyzing-model-performance"><span class="toc-section-number">10.5</span>  Analyzing Model Performance</a></li>
  <li><a href="#saving-and-loading-the-model" id="toc-saving-and-loading-the-model" class="nav-link" data-scroll-target="#saving-and-loading-the-model"><span class="toc-section-number">10.6</span>  Saving and Loading the model</a></li>
  <li><a href="#performing-inference" id="toc-performing-inference" class="nav-link" data-scroll-target="#performing-inference"><span class="toc-section-number">10.7</span>  Performing inference</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion"><span class="toc-section-number">10.8</span>  Conclusion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Modeling pipeline with fastai’s High-Level API</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>This chapter will cover the process of training a model for multi-class classification on MNIST data using the fastai high(application)-level API. The image below illustrates the general steps involved in using the high-level API:</p>
<figure align="center" class="figure">
<img src="./img/fastai_highlevelflow.png" style="width:100%" class="figure-img">
<figcaption align="center" class="figure-caption">
Fig 10.1: Using fastai high-level API flow.
</figcaption>
</figure>
<section id="download-data" class="level2" data-number="10.1">
<h2 data-number="10.1" class="anchored" data-anchor-id="download-data"><span class="header-section-number">10.1</span> Download data</h2>
<p>Download instruction can be found in <a href="../nbs/8_NeuralNetworks.html#downloading-data-from-kaggle"><code>Downloading Data from Kaggle</code></a> section of Modeling pipeline with Neural Networks chapter.</p>
</section>
<section id="creating-dataloaders" class="level2" data-number="10.2">
<h2 data-number="10.2" class="anchored" data-anchor-id="creating-dataloaders"><span class="header-section-number">10.2</span> Creating DataLoaders</h2>
<p>First step in the process is creating a fastai <code>Dataloaders</code>. To begin, we will import the <code>fastai.vision</code> module, as we are working with image classification tasks in this case.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-04-25T05:56:20.100230Z&quot;,&quot;start_time&quot;:&quot;2023-04-25T05:56:17.913655Z&quot;}" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-important callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Important
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<p>It is generally not recommended to use <code>import *</code> in production scenarios. Instead, it is advisable to use precise imports. For instance, the function <code>ImageDataLoaders</code> is located in the <a href="https://github.com/fastai/fastai/blob/master/fastai/vision/data.py#L108"><code>fastai.vision</code></a> module, specifically in the <code>data.py</code> file. Therefore, the recommended import statement would be:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.data <span class="im">import</span> ImageDataLoaders</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This approach ensures that only the required function is imported, which is considered a good coding practice in production environments.</p>
<p>For simplicity, we will stick with <code>import *</code> notion.</p>
</div>
</div>
</div>
<p>Next, we will create our <code>fastai</code> <code>dataloaders</code> object.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<p>It’s important to note that <code>fastai</code> <code>DataLoaders</code> are not identical to PyTorch <code>dataloaders</code>. In <code>fastai</code>, many of the PyTorch classes are inherited and additional functionalities are added through a technique called <a href="https://en.wikipedia.org/wiki/Monkey_patch#:~:text=Monkey%20patching%20is%20a%20technique,Python%2C%20Groovy%2C%20etc.">“monkey-patching”</a>. This means that <code>fastai</code> extends the functionality of PyTorch classes by adding custom features and methods, providing a higher-level and more user-friendly API for deep learning tasks.</p>
</div>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-04-25T05:56:24.330559Z&quot;,&quot;start_time&quot;:&quot;2023-04-25T05:56:20.276953Z&quot;}" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>dPath <span class="op">=</span> Path(<span class="st">"../data/mnist_png/"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> ImageDataLoaders.from_folder(</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>        path <span class="op">=</span> dPath, </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>        train <span class="op">=</span> <span class="st">"training"</span>, </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>        valid_pct <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>        seed<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>        img_cls <span class="op">=</span> PILImageBW,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>        item_tfms<span class="op">=</span>Resize(<span class="dv">28</span>),</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>        batch_tfms<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        bs<span class="op">=</span><span class="dv">128</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">type</span>(dls))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'fastai.data.core.DataLoaders'&gt;</code></pre>
</div>
</div>
<p>As evident from the code snippet above, it is possible to create a <code>fastai</code> <code>DataLoaders</code> in just one line of code. Let’s delve into the details of what’s happening with this function. The code above is creating a <code>fastai</code> <code>DataLoaders</code> object named <code>dls</code> using the <code>from_folder</code> method of <code>ImageDataLoaders</code> class. Here’s a breakdown of the parameters being passed:</p>
<ul>
<li><code>path</code>: The path to the dataset folder is specified as <code>dPath</code>, which uses the <code>fastai</code> <code>Path</code> function. It’s important to note that the <code>Path</code> function in <code>fastai</code> is a monkey-patched version of the standard <a href="https://docs.python.org/3/library/pathlib.html"><code>pathlib.Path</code></a> function in Python.</li>
<li><code>train</code>: The name of the subfolder within the dataset folder that contains the training data, specified as “training”.</li>
<li><code>valid_pct</code>: The validation data percentage is set to 0.2 (20%), which means that the data will be randomly split into training and validation sets. Specifically, 80% of the data will be used for training, while 20% will be used for validation.</li>
<li><code>seed</code>: The random seed used for reproducibility, specified as 42.</li>
<li><code>img_cls</code>: The image class to be used is specified as <a href="(https://docs.fast.ai/vision.core.html#pilimagebw)"><code>PILImageBW</code></a>, as the MNIST images are black and white single-channel images. <code>PILImageBW</code> is one of the general data types available in the <a href="https://docs.fast.ai/vision.core.html"><code>vision.core</code></a> module of the <code>fastai</code> library.</li>
<li><code>item_tfms</code>: The image transformation to be applied to each item, specified as Resize(28) which resizes the images to a size of 28x28 pixels. This operation is performed on CPU.</li>
<li><code>batch_tfms</code>: The batch transformations to be applied, specified as None which means no batch transformations are applied. <code>batch_tfms</code> is usually transforms performed on GPU.</li>
<li><code>bs</code>: The batch size, specified as 128.</li>
</ul>
<p>Finally, the <code>type(dls)</code> statement is used to print the type of the dls object, which should be a <code>fastai</code> <code>DataLoaders</code> object.</p>
<p><code>fastai</code> offers various functions for easy inspection of data through data loaders. Let’s use the <code>show_batch</code> function to visualize one batch of the data.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-04-25T05:56:27.734504Z&quot;,&quot;start_time&quot;:&quot;2023-04-25T05:56:26.317160Z&quot;}" data-execution_count="3">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>dls.show_batch(figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">6</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="10_MNISTusingFastaiHighLevelAPI_files/figure-html/cell-4-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>It appears that we have successfully created a data loader with just one line of code. To better inspect the data, we can check the dimensions of a batch of data. Let’s use the <code>one_batch</code> function on the <code>dls</code> data loader object to obtain a single batch of data.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-04-25T05:56:30.093412Z&quot;,&quot;start_time&quot;:&quot;2023-04-25T05:56:28.953898Z&quot;}" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>x,y <span class="op">=</span> dls.one_batch()</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Shape of X:</span><span class="sc">{</span>x<span class="sc">.</span>shape<span class="sc">}</span><span class="ss"> </span><span class="ch">\n</span><span class="ss">Shape of Labels:</span><span class="sc">{</span>y<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Shape of X:torch.Size([128, 1, 28, 28]) 
Shape of Labels:torch.Size([128])</code></pre>
</div>
</div>
<p>Upon inspection, we can observe that the input image batch has the following dimensions:</p>
<ul>
<li>Batch size: 128</li>
<li>Number of channels: 1 (single channel)</li>
<li>Image height: 28</li>
<li>Image width: 28</li>
</ul>
<p>Additionally, the labels are represented as a vector of size 128, with one label per image.</p>
</section>
<section id="creating-a-learner" class="level2" data-number="10.3">
<h2 data-number="10.3" class="anchored" data-anchor-id="creating-a-learner"><span class="header-section-number">10.3</span> Creating a learner</h2>
<p>The next step involves creating a <code>fastai</code> <a href="https://docs.fast.ai/learner.html#learner"><code>Learner</code></a> object using the <a href="https://docs.fast.ai/vision.learner.html"><code>vision_learner</code></a> method.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-04-25T05:56:31.826967Z&quot;,&quot;start_time&quot;:&quot;2023-04-25T05:56:31.709234Z&quot;}" data-execution_count="5">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    dls<span class="op">=</span>dls,  </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    arch<span class="op">=</span> resnet18, </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    pretrained<span class="op">=</span><span class="va">False</span>, </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    metrics<span class="op">=</span>accuracy, </span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    n_in<span class="op">=</span><span class="dv">1</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">type</span>(learn))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'fastai.learner.Learner'&gt;</code></pre>
</div>
</div>
<p>As evident from the code snippet above, it is possible to create a <code>fastai</code> <code>Learner</code> in just one line of code. Let’s delve into the details of what’s happening with this function. The code above is creating a fastai <code>Learner</code> object for training a model on the MNIST dataset. Here’s what each parameter in the vision_learner method does:</p>
<ul>
<li><code>dls</code>: This parameter specifies the data loaders object (dls) that we previously created for the dataset.</li>
<li><code>arch</code>: The <code>arch</code> parameter specifies the neural network architecture to be used for training. In this case, we are using <a href="https://pytorch.org/vision/0.8/models.html">resnet18</a> from <code>torchvision.models</code>, which is a popular convolutional neural network architecture. <code>fastai</code> models are PyTorch models, so they can accept any valid PyTorch model, whether it is custom-defined or sourced from the <a href="https://pytorch.org/vision/0.8/models.html"><code>torchvision</code></a> model hub or <a href="https://huggingface.co/docs/timm/"><code>timm</code></a> library, by simply specifying the model name. This allows for flexibility in choosing different neural network architectures for training, depending on the specific requirements of the task at hand.</li>
<li><code>pretrained</code>: This parameter indicates whether to use pre-trained weights for the neural network. In this case, False means that we are not using any pre-trained weights.</li>
<li><code>metrics</code>: This parameter specifies the evaluation metric(s) to be used during training. In this case, <a href="https://docs.fast.ai/metrics.html#accuracy"><code>accuracy</code></a> is used, which measures the classification accuracy. <code>fastai</code> provides other pre-implemented single-label classification metrics that you can use, and you can find them in the <a href="https://docs.fast.ai/metrics.html#single-label-classification">metrics documentation</a>.</li>
<li><code>n_in</code> : This parameter specifies the number of input channels in the images. Since the MNIST images are grayscale with a single channel, n_in is set to 1.</li>
</ul>
<p>The <code>type(learn)</code> statement is then used to print the type of the <code>learn</code> object, which should be a <code>fastai</code> <code>Learner</code> object.</p>
<div class="callout-important callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Important
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<p>The <a href="https://docs.fast.ai/vision.learner.html#vision_learner"><code>vision_learner</code></a> class in <code>fastai</code> comes with a lot of “useful defaults” that have been derived from training task in hand on various datasets. For instance, it automatically selects the <code>AdamW</code> optimizer as the default optimization function, sets the learning rate to <code>0.001</code> by default and loss function as <a href="https://docs.fast.ai/losses.html#crossentropylossflat">flattened CrossEntropyLoss</a>. You can refer to the <a href="https://docs.fast.ai/vision.learner.html#vision_learner">documentation of vision_learner</a> to explore other default settings and configurations that may be useful for your specific task.</p>
</div>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-04-25T05:56:34.016538Z&quot;,&quot;start_time&quot;:&quot;2023-04-25T05:56:34.013822Z&quot;}" data-execution_count="6">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Optimizer function used: </span><span class="sc">{</span>learn<span class="sc">.</span>opt_func<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Default learning rate: </span><span class="sc">{</span>learn<span class="sc">.</span>lr<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Default loss function: </span><span class="sc">{</span>learn<span class="sc">.</span>loss_func<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Optimizer function used: &lt;function Adam at 0x7f53ce8a6e50&gt;
Default learning rate: 0.001
Default loss function: FlattenedLoss of CrossEntropyLoss()</code></pre>
</div>
</div>
<p><code>fastai</code> <code>Learner</code> class also comes with a lot of helpful functions. An example would be <a href="https://github.com/fastai/fastai/blob/master/fastai/callback/hook.py#L209"><code>Learner.summary</code></a> function which prints a summary of the model, optimizer and loss function.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-04-25T05:56:39.149115Z&quot;,&quot;start_time&quot;:&quot;2023-04-25T05:56:35.197853Z&quot;}" data-execution_count="7">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>learn.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>Sequential (Input shape: 128 x 1 x 28 x 28)
============================================================================
Layer (type)         Output Shape         Param #    Trainable 
============================================================================
                     128 x 64 x 14 x 14  
Conv2d                                    3136       True      
BatchNorm2d                               128        True      
ReLU                                                           
____________________________________________________________________________
                     128 x 64 x 7 x 7    
MaxPool2d                                                      
Conv2d                                    36864      True      
BatchNorm2d                               128        True      
ReLU                                                           
Conv2d                                    36864      True      
BatchNorm2d                               128        True      
Conv2d                                    36864      True      
BatchNorm2d                               128        True      
ReLU                                                           
Conv2d                                    36864      True      
BatchNorm2d                               128        True      
____________________________________________________________________________
                     128 x 128 x 4 x 4   
Conv2d                                    73728      True      
BatchNorm2d                               256        True      
ReLU                                                           
Conv2d                                    147456     True      
BatchNorm2d                               256        True      
Conv2d                                    8192       True      
BatchNorm2d                               256        True      
Conv2d                                    147456     True      
BatchNorm2d                               256        True      
ReLU                                                           
Conv2d                                    147456     True      
BatchNorm2d                               256        True      
____________________________________________________________________________
                     128 x 256 x 2 x 2   
Conv2d                                    294912     True      
BatchNorm2d                               512        True      
ReLU                                                           
Conv2d                                    589824     True      
BatchNorm2d                               512        True      
Conv2d                                    32768      True      
BatchNorm2d                               512        True      
Conv2d                                    589824     True      
BatchNorm2d                               512        True      
ReLU                                                           
Conv2d                                    589824     True      
BatchNorm2d                               512        True      
____________________________________________________________________________
                     128 x 512 x 1 x 1   
Conv2d                                    1179648    True      
BatchNorm2d                               1024       True      
ReLU                                                           
Conv2d                                    2359296    True      
BatchNorm2d                               1024       True      
Conv2d                                    131072     True      
BatchNorm2d                               1024       True      
Conv2d                                    2359296    True      
BatchNorm2d                               1024       True      
ReLU                                                           
Conv2d                                    2359296    True      
BatchNorm2d                               1024       True      
AdaptiveAvgPool2d                                              
AdaptiveMaxPool2d                                              
____________________________________________________________________________
                     128 x 1024          
Flatten                                                        
BatchNorm1d                               2048       True      
Dropout                                                        
____________________________________________________________________________
                     128 x 512           
Linear                                    524288     True      
ReLU                                                           
BatchNorm1d                               1024       True      
Dropout                                                        
____________________________________________________________________________
                     128 x 10            
Linear                                    5120       True      
____________________________________________________________________________

Total params: 11,702,720
Total trainable params: 11,702,720
Total non-trainable params: 0

Optimizer used: &lt;function Adam at 0x7f53ce8a6e50&gt;
Loss function: FlattenedLoss of CrossEntropyLoss()

Callbacks:
  - TrainEvalCallback
  - CastToTensor
  - Recorder
  - ProgressCallback</code></pre>
</div>
</div>
<p>The <code>Learner.summary</code> function provides a wealth of useful information, including:</p>
<ul>
<li>Model layers and their trainable state</li>
<li>Total number of parameters in the model, as well as the number of trainable parameters</li>
<li>The optimizer used during training</li>
<li>The loss function employed</li>
<li>The <a href="https://docs.fast.ai/callback.core.html">callbacks</a> used, which are special additional functions that run at various stages of training and inference. You can refer to the <a href="https://docs.fast.ai/callback.core.html">documentation on callbacks</a> to learn more about them.</li>
</ul>
</section>
<section id="training-the-model" class="level2" data-number="10.4">
<h2 data-number="10.4" class="anchored" data-anchor-id="training-the-model"><span class="header-section-number">10.4</span> Training the model</h2>
<p><code>fastai</code> provides different <code>fit</code> functions in the <code>Learner</code> class that allow for flexible and convenient training of machine learning models. Here’s an overview of some of the commonly used <code>fit</code> functions in Fastai:</p>
<ol type="1">
<li><p><a href="https://docs.fast.ai/learner.html#learner.fit"><code>fit</code></a>: This is the most commonly used <code>fit</code> function in <code>fastai</code>, which trains the model using stochastic gradient descent (SGD) or its variants. It allows you to specify the number of epochs, learning rate, weight decay, and other training parameters. You can also specify callbacks for custom behavior during training.</p></li>
<li><p><a href="https://docs.fast.ai/callback.schedule.html#learner.fit_one_cycle"><code>fit_one_cycle</code></a>: This function implements the 1-cycle policy, a popular learning rate scheduling technique in deep learning. It automatically sets the learning rate, momentum, and weight decay to optimal values based on a predefined schedule. This can help improve the model’s performance and speed up training.</p></li>
<li><p><a href="https://docs.fast.ai/callback.schedule.html#learner.fit_sgdr"><code>fit_sgdr</code></a>: This function implements stochastic gradient descent with restarts (SGDR), a learning rate scheduling technique that periodically resets the learning rate to a smaller value during training. This helps the model escape from local minima and find better solutions.</p></li>
<li><p><a href="https://docs.fast.ai/callback.schedule.html#learner.fit_flat_cos"><code>fit_flat_cos</code></a>: This function uses a cosine annealing learning rate schedule, where the learning rate is decreased gradually over time following a cosine curve. This helps the model converge to a better solution by avoiding overshooting.</p></li>
<li><p><a href="https://docs.fast.ai/callback.schedule.html#learner.fine_tune"><code>fine_tune</code></a>: This function fine-tunes a pre-trained model by training only the last few layers while keeping the earlier layers frozen. This is useful for transfer learning, where you start with a pre-trained model and then fine-tune it on your specific task with limited data.</p></li>
</ol>
<p>These are some of the different <code>fit</code> functions available in <code>fastai</code>’s <code>Learner</code> class, providing flexibility and convenience for training machine learning models with various techniques and strategies.</p>
<p>We will use <code>fit_one_cycle</code> function for our training example and train for five epochs.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-04-25T06:00:41.215640Z&quot;,&quot;start_time&quot;:&quot;2023-04-25T05:56:42.981424Z&quot;}" data-execution_count="8">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.174721</td>
      <td>0.149860</td>
      <td>0.958000</td>
      <td>00:48</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.097696</td>
      <td>0.082462</td>
      <td>0.976143</td>
      <td>00:46</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.062112</td>
      <td>0.063939</td>
      <td>0.982357</td>
      <td>00:47</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.029472</td>
      <td>0.030471</td>
      <td>0.990286</td>
      <td>00:47</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.012919</td>
      <td>0.026187</td>
      <td>0.992857</td>
      <td>00:47</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<p>As we can see above, the <code>fit_one_cycle</code> function in <code>fastai</code> provides a progress bar(while training, not shown above) and displays statistics in a neat table after every epoch, which includes:</p>
<ul>
<li>Train and validation loss</li>
<li>The defined metric, in this case <code>accuracy</code> on the validation set</li>
<li>Time taken to run that particular epoch</li>
</ul>
</section>
<section id="analyzing-model-performance" class="level2" data-number="10.5">
<h2 data-number="10.5" class="anchored" data-anchor-id="analyzing-model-performance"><span class="header-section-number">10.5</span> Analyzing Model Performance</h2>
<p>After training our model, we achieved an impressive accuracy rate of over 99% on the MNIST testing dataset. Additionally, <code>fastai</code> provides convenient functions such as <code>ClassificationInterpretation</code>, which allows us to easily plot losses and generate a confusion matrix for further model evaluation and analysis. These tools are useful in gaining insights into the performance of our trained model and making informed decisions for model refinement and improvement.</p>
<p>First we will initiate <code>ClassificationInterpretation</code> object from our model.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-04-25T06:00:50.759111Z&quot;,&quot;start_time&quot;:&quot;2023-04-25T06:00:41.268009Z&quot;}" data-execution_count="9">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>interp <span class="op">=</span> ClassificationInterpretation.from_learner(learn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<p>We can now visualize our top losses, which are examples where our model was highly confident in its prediction but got it wrong. By examining these cases, we can identify potential issues with the data labeling process or areas where our model struggles in accurately identifying the class of the image. Here in <code>plot_top_losses</code> we have passed two arguments:</p>
<ul>
<li>Number of images to be displayed</li>
<li>Figure size</li>
</ul>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-04-25T06:00:51.479472Z&quot;,&quot;start_time&quot;:&quot;2023-04-25T06:00:50.817161Z&quot;}" data-execution_count="10">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>interp.plot_top_losses(<span class="dv">9</span>, figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">6</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<p><img src="10_MNISTusingFastaiHighLevelAPI_files/figure-html/cell-11-output-3.png" class="img-fluid"></p>
</div>
</div>
<p>From the above example, we can observe that our model occasionally confuses between:</p>
<ul>
<li>Digits 1, 2, and 7</li>
<li>Digits 0, 5, and 8</li>
</ul>
<p>This is not uncommon, as these digits bear a close resemblance to each other. It is important to note that such misclassifications are not necessarily indicative of a problem with our model, but rather a reflection of the inherent similarities between these digits.</p>
<p>We can also generate a visualization of the confusion matrix using the <code>plot_confusion_matrix</code> function. This allows us to gain further insights into the performance of our model by visually representing the misclassifications and the true positive rates for each class.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-04-25T06:01:02.099582Z&quot;,&quot;start_time&quot;:&quot;2023-04-25T06:00:51.530403Z&quot;}" data-execution_count="11">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>interp.plot_confusion_matrix(figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">12</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<p><img src="10_MNISTusingFastaiHighLevelAPI_files/figure-html/cell-12-output-3.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="saving-and-loading-the-model" class="level2" data-number="10.6">
<h2 data-number="10.6" class="anchored" data-anchor-id="saving-and-loading-the-model"><span class="header-section-number">10.6</span> Saving and Loading the model</h2>
<p>We can save the model weights, optimizer state and <code>DataLoaders</code> transform by using <code>export</code> function.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>We will explore additional techniques for extracting model weights beyond what has been covered so far in later chapters.</p>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-04-23T23:06:33.278386Z&quot;,&quot;start_time&quot;:&quot;2023-04-23T23:06:33.101724Z&quot;}" data-execution_count="22">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>learn.export(fname<span class="op">=</span><span class="st">"mnist_highlevel.pkl"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To load the model we can use <code>load_learner</code> function.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-04-23T23:24:43.812001Z&quot;,&quot;start_time&quot;:&quot;2023-04-23T23:24:43.726410Z&quot;}" data-execution_count="50">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> load_learner(</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    fname<span class="op">=</span>dPath<span class="op">/</span><span class="st">"mnist_highlevel.pkl"</span>, </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    cpu<span class="op">=</span><span class="va">True</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>load_learner</code> function takes following arguments -</p>
<ul>
<li><code>fname</code> - The path of the saved learner object</li>
<li><code>cpu</code> - This parameter is set to <code>True</code>, indicating that the learner object should be loaded onto the CPU for inference.</li>
</ul>
</section>
<section id="performing-inference" class="level2" data-number="10.7">
<h2 data-number="10.7" class="anchored" data-anchor-id="performing-inference"><span class="header-section-number">10.7</span> Performing inference</h2>
<p>To perform inference, we will first obtain the file path of an image from our testing folder.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-04-23T23:16:12.674645Z&quot;,&quot;start_time&quot;:&quot;2023-04-23T23:16:12.655918Z&quot;}" data-execution_count="47">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>fname <span class="op">=</span> (dPath<span class="op">/</span><span class="st">"testing/4"</span>).ls()[<span class="dv">0</span>]</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Sample file path: </span><span class="sc">{</span>fname<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>Image.<span class="bu">open</span>(fname)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sample file path: ../data/mnist_png/testing/4/1010.png</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="47">
<p><img src="10_MNISTusingFastaiHighLevelAPI_files/figure-html/cell-15-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>We have selected an image of the digit four from our test dataset. To perform inference we will use the <a href="https://docs.fast.ai/learner.html#learner.predict"><code>predict</code></a> method from <code>Learner</code> class.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-04-23T23:17:20.306028Z&quot;,&quot;start_time&quot;:&quot;2023-04-23T23:17:20.219794Z&quot;}" data-execution_count="48">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> learn.predict(fname)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(preds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>('4', TensorBase(4), TensorBase([1.6044e-06, 2.5403e-06, 2.2100e-06, 2.8801e-07, 9.9986e-01,
            4.1187e-07, 1.7771e-05, 2.4048e-05, 5.0337e-07, 9.5490e-05]))</code></pre>
</div>
</div>
<p>The prediction results include the following information:</p>
<ul>
<li>decoded model label: <code>4</code>.</li>
<li>The index with highest probability: <code>TensorBase(4)</code>.</li>
<li>Raw probabilities of each class in the vocabulary.</li>
</ul>
</section>
<section id="conclusion" class="level2" data-number="10.8">
<h2 data-number="10.8" class="anchored" data-anchor-id="conclusion"><span class="header-section-number">10.8</span> Conclusion</h2>
<p>In this chapter, we delved into the intricacies of building a model pipeline using <code>fastai</code>’s high-level API. We covered the essential steps of data preparation, model training, and inference, and demonstrated how the rich functionality of <code>fastai</code>’s high-level API can streamline these processes using MNIST data. In the next chapter, we will continue our journey by exploring similar concepts but with a focus on <code>fastai</code>’s mid-level API.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../nbs/9_IntroductionToFastAI.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Introduction to fastai</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../nbs/11_MNISTusingFastaiMidLevelAPI.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Modeling pipeline with fastai’s Mid-Level API (draft)</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">The PyTorch book. Copyright (c) 2022 Aayush Agrawal.</div>   
    <div class="nav-footer-right">This book was built with <a href="https://quarto.org/">Quarto</a></div>
  </div>
</footer>



</body></html>