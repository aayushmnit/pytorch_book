<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.226">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>The PyTorch Book - 8&nbsp; Neural Networks</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../basics/9_NeuralNetworkWithFastAI.html" rel="next">
<link href="../basics/7_models.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-Q8J05XS7Q7"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-Q8J05XS7Q7', { 'anonymize_ip': true});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Neural Networks</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">The PyTorch Book</a> 
        <div class="sidebar-tools-main">
    <a href="" title="Share" id="sidebar-tool-dropdown-0" class="sidebar-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-share"></i></a>
    <ul class="dropdown-menu" aria-labelledby="sidebar-tool-dropdown-0">
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=|url|">
            <i class="bi bi-bi-linkedin pe-1"></i>
          LinkedIn
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
            <i class="bi bi-bi-twitter pe-1"></i>
          Twitter
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
            <i class="bi bi-bi-facebook pe-1"></i>
          Facebook
          </a>
        </li>
    </ul>
  <a href="" class="quarto-color-scheme-toggle sidebar-tool" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">Preface</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">PyTorch basics</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../basics/1_pytorch_intro.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">PyTorch Introduction and Installation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../basics/2_pytorch_tensors.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Tensors</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../basics/3_broadcasting.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Broadcasting</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../basics/4_autograd.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Automatic Differentiation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../basics/5_datasets.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Datasets and Dataloaders</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../basics/6_optimizers.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Optimizers and Learning loops</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../basics/7_models.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Model building</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../basics/8_NeuralNetworks.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Neural Networks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../basics/9_NeuralNetworkWithFastAI.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Neural Networks with fastai (draft)</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#downloading-data-from-kaggle" id="toc-downloading-data-from-kaggle" class="nav-link active" data-scroll-target="#downloading-data-from-kaggle"><span class="toc-section-number">8.1</span>  Downloading Data from Kaggle</a></li>
  <li><a href="#creating-dataset-object" id="toc-creating-dataset-object" class="nav-link" data-scroll-target="#creating-dataset-object"><span class="toc-section-number">8.2</span>  Creating Dataset Object</a>
  <ul class="collapse">
  <li><a href="#using-pure-pytorch" id="toc-using-pure-pytorch" class="nav-link" data-scroll-target="#using-pure-pytorch"><span class="toc-section-number">8.2.1</span>  Using Pure Pytorch</a></li>
  <li><a href="#using-torchvision" id="toc-using-torchvision" class="nav-link" data-scroll-target="#using-torchvision"><span class="toc-section-number">8.2.2</span>  Using Torchvision</a></li>
  </ul></li>
  <li><a href="#create-a-dataloader" id="toc-create-a-dataloader" class="nav-link" data-scroll-target="#create-a-dataloader"><span class="toc-section-number">8.3</span>  Create a Dataloader</a></li>
  <li><a href="#defining-our-training-and-validation-loops" id="toc-defining-our-training-and-validation-loops" class="nav-link" data-scroll-target="#defining-our-training-and-validation-loops"><span class="toc-section-number">8.4</span>  Defining our Training and Validation loops</a></li>
  <li><a href="#training-using-a-fully-connected-multi-layer-perceptron-model" id="toc-training-using-a-fully-connected-multi-layer-perceptron-model" class="nav-link" data-scroll-target="#training-using-a-fully-connected-multi-layer-perceptron-model"><span class="toc-section-number">8.5</span>  Training using a Fully Connected/ Multi Layer Perceptron Model</a></li>
  <li><a href="#training-using-a-simple-cnn-model" id="toc-training-using-a-simple-cnn-model" class="nav-link" data-scroll-target="#training-using-a-simple-cnn-model"><span class="toc-section-number">8.6</span>  Training using a simple CNN model</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion"><span class="toc-section-number">8.7</span>  Conclusion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Neural Networks</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>In previous chapters, we covered the fundamentals of PyTorch and applied it to a linear regression example. Now, we will expand on that knowledge by constructing neural networks using PyTorch. The dataset we will be utilizing is the <code>MNIST png</code> dataset from <a href="https://www.kaggle.com/datasets/jidhumohan/mnist-png">Kaggle</a>, as opposed to the CSV version, for a more practical experience.</p>
<section id="downloading-data-from-kaggle" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="downloading-data-from-kaggle"><span class="header-section-number">8.1</span> Downloading Data from Kaggle</h2>
<p>Here are few steps you need to perform before we download the data -</p>
<ul>
<li><p>If you don’t have a Kaggle account, you can make one for free <a href="https://www.kaggle.com/">here</a>.</p></li>
<li><p>To download the dataset, you will need <code>kaggle</code> installed, you can run the following command in notebook or CLI.</p>
<pre class="{python}"><code>!pip install kaggle &gt;&gt; /dev/null</code></pre></li>
<li><p>Have a <code>kaggle.json</code> stored in <code>~/.kaggle</code>. You can get your token by going to Your Profile -&gt; Account -&gt; Create New API Token.</p></li>
</ul>
<p>Once you have the above three steps done, run the API command provided:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-01-23T07:08:30.081823Z&quot;,&quot;start_time&quot;:&quot;2023-01-23T07:08:27.410023Z&quot;}" data-execution_count="14">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>kaggle datasets download <span class="op">-</span>d jidhumohan<span class="op">/</span>mnist<span class="op">-</span>png <span class="op">-</span>p <span class="st">"../data/"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Downloading mnist-png.zip to ../data
 87%|█████████████████████████████████     | 51.0M/58.6M [00:01&lt;00:00, 33.4MB/s]
100%|██████████████████████████████████████| 58.6M/58.6M [00:01&lt;00:00, 33.9MB/s]</code></pre>
</div>
</div>
<p>To examine the file system, we will utilize the <a href="https://fastcore.fast.ai/">fastcore</a> <code>Path</code> function. It enhances the functionality of python’s <code>Path</code> class and simplifies the process of inspecting directories and folders.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-01-23T07:09:02.914814Z&quot;,&quot;start_time&quot;:&quot;2023-01-23T07:09:02.909221Z&quot;}" data-execution_count="2">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastcore.xtras <span class="im">import</span> Path</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>zip_path <span class="op">=</span> Path(<span class="st">"../data/mnist-png.zip"</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>zip_path.exists() <span class="co"># Check if the file exist</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre><code>True</code></pre>
</div>
</div>
<p>The data has been persisted to the <code>mnist-png.zip</code> file on the local system, within the <code>../data</code> directory. The next step is to utilize the <code>zipfile</code> package to extract the contents of the archive.</p>
<div class="callout-warning callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>The execution of the following code block will take a significant amount of time(6-10 mins) as it involves the extraction of 70,000 PNG images.</p>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-01-23T07:26:53.546813Z&quot;,&quot;start_time&quot;:&quot;2023-01-23T07:20:17.810346Z&quot;}" data-execution_count="11">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Output directory</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>dPath <span class="op">=</span> Path(<span class="st">"../data/"</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Unzipping data file in output directory</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> zipfile</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> zipfile.ZipFile(zip_path, <span class="st">"r"</span>) <span class="im">as</span> zip_ref:</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    zip_ref.extractall(<span class="bu">str</span>(dPath))</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Removing the original zip file</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>zip_path.unlink()</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Removing duplicate folder in the unzipped data</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shutil</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>dPath <span class="op">=</span> dPath<span class="op">/</span><span class="st">'mnist_png'</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>shutil.rmtree(dPath<span class="op">/</span><span class="st">'mnist_png'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we inspect the extracted folder.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-01-24T05:44:59.458399Z&quot;,&quot;start_time&quot;:&quot;2023-01-24T05:44:59.451705Z&quot;}" data-execution_count="3">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>dPath.ls()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>(#2) [Path('../data/mnist_png/testing'),Path('../data/mnist_png/training')]</code></pre>
</div>
</div>
<p>Data contains of two folder <code>training</code> and <code>testing</code>. Next, we inspect <code>training</code> folder.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-01-24T05:45:00.248286Z&quot;,&quot;start_time&quot;:&quot;2023-01-24T05:45:00.243566Z&quot;}" data-execution_count="4">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>(dPath<span class="op">/</span><span class="st">'training'</span>).ls()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>(#10) [Path('../data/mnist_png/training/0'),Path('../data/mnist_png/training/1'),Path('../data/mnist_png/training/2'),Path('../data/mnist_png/training/3'),Path('../data/mnist_png/training/4'),Path('../data/mnist_png/training/5'),Path('../data/mnist_png/training/6'),Path('../data/mnist_png/training/7'),Path('../data/mnist_png/training/8'),Path('../data/mnist_png/training/9')]</code></pre>
</div>
</div>
<p>The <code>training</code> folder comprises of subfolders for each digit ranging from <code>0</code> to <code>9</code>.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-01-24T05:45:01.964031Z&quot;,&quot;start_time&quot;:&quot;2023-01-24T05:45:01.926482Z&quot;}" data-execution_count="5">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>(dPath<span class="op">/</span><span class="st">'training/0'</span>).ls()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>(#5923) [Path('../data/mnist_png/training/0/1.png'),Path('../data/mnist_png/training/0/1000.png'),Path('../data/mnist_png/training/0/10005.png'),Path('../data/mnist_png/training/0/10010.png'),Path('../data/mnist_png/training/0/10022.png'),Path('../data/mnist_png/training/0/10025.png'),Path('../data/mnist_png/training/0/10026.png'),Path('../data/mnist_png/training/0/10045.png'),Path('../data/mnist_png/training/0/10069.png'),Path('../data/mnist_png/training/0/10071.png')...]</code></pre>
</div>
</div>
<p>Each of these digit subfolders contains images. We will proceed to load a few of these images.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-01-24T05:45:02.982371Z&quot;,&quot;start_time&quot;:&quot;2023-01-24T05:45:02.878538Z&quot;}" data-execution_count="6">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> display</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> img <span class="kw">in</span> [Image.<span class="bu">open</span>((dPath<span class="op">/</span><span class="st">'training/0'</span>).ls()[<span class="dv">0</span>]), </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>            Image.<span class="bu">open</span>((dPath<span class="op">/</span><span class="st">'training/1'</span>).ls()[<span class="dv">0</span>]),</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>            Image.<span class="bu">open</span>((dPath<span class="op">/</span><span class="st">'training/2'</span>).ls()[<span class="dv">0</span>]),</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>            Image.<span class="bu">open</span>((dPath<span class="op">/</span><span class="st">'training/3'</span>).ls()[<span class="dv">0</span>])]: </span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    display(img)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="8_NeuralNetworks_files/figure-html/cell-8-output-1.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="8_NeuralNetworks_files/figure-html/cell-8-output-2.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="8_NeuralNetworks_files/figure-html/cell-8-output-3.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="8_NeuralNetworks_files/figure-html/cell-8-output-4.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="creating-dataset-object" class="level2" data-number="8.2">
<h2 data-number="8.2" class="anchored" data-anchor-id="creating-dataset-object"><span class="header-section-number">8.2</span> Creating Dataset Object</h2>
<p>As previously discussed, prior to training the model, it is necessary to establish a data pipeline in PyTorch. This includes defining a <code>Dataset</code> object and subsequently loading it via a PyTorch <code>Dataloader</code>.</p>
<section id="using-pure-pytorch" class="level3" data-number="8.2.1">
<h3 data-number="8.2.1" class="anchored" data-anchor-id="using-pure-pytorch"><span class="header-section-number">8.2.1</span> Using Pure Pytorch</h3>
<p>Initially, we will demonstrate the process of constructing a custom image <code>Dataset</code> object using pure PyTorch. To begin, we will import the necessary libraries.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-01-24T05:45:10.437520Z&quot;,&quot;start_time&quot;:&quot;2023-01-24T05:45:09.414739Z&quot;}" data-execution_count="7">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch <span class="im">import</span> nn</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> Dataset</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>glob</code> library can be utilized to obtain the filepaths of all images within a directory.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-01-24T05:45:13.027568Z&quot;,&quot;start_time&quot;:&quot;2023-01-24T05:45:12.822235Z&quot;}" data-execution_count="8">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>train_paths <span class="op">=</span> glob.glob(<span class="bu">str</span>(dPath<span class="op">/</span><span class="st">'training/**/*.png'</span>))</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>test_paths <span class="op">=</span> glob.glob(<span class="bu">str</span>(dPath<span class="op">/</span><span class="st">'testing/**/*.png'</span>))</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Training images count: </span><span class="sc">{</span><span class="bu">len</span>(train_paths)<span class="sc">}</span><span class="ss"> </span><span class="ch">\n</span><span class="ss">Testing images count: </span><span class="sc">{</span><span class="bu">len</span>(test_paths)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(train_paths[<span class="dv">0</span>:<span class="dv">5</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Training images count: 60000 
Testing images count: 10000
['../data/mnist_png/training/0/1.png', '../data/mnist_png/training/0/1000.png', '../data/mnist_png/training/0/10005.png', '../data/mnist_png/training/0/10010.png', '../data/mnist_png/training/0/10022.png']</code></pre>
</div>
</div>
<p>By utilizing <code>glob</code>, we have successfully obtained the filepaths of all images within the <code>training</code> and <code>testing</code> folders. We can see there are 60,000 training images and 10,000 testing images. The next step is to extract the labels from the folder names.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-01-24T06:02:04.130044Z&quot;,&quot;start_time&quot;:&quot;2023-01-24T06:02:04.113784Z&quot;}" data-execution_count="30">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>train_targets <span class="op">=</span> <span class="bu">list</span>(<span class="bu">map</span>(<span class="kw">lambda</span> x: <span class="bu">int</span>(x.split(<span class="st">'/'</span>)[<span class="op">-</span><span class="dv">2</span>]), train_paths))</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>test_targets  <span class="op">=</span> <span class="bu">list</span>(<span class="bu">map</span>(<span class="kw">lambda</span> x: <span class="bu">int</span>(x.split(<span class="st">'/'</span>)[<span class="op">-</span><span class="dv">2</span>]), test_paths))</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Training labels count: </span><span class="sc">{</span><span class="bu">len</span>(train_targets)<span class="sc">}</span><span class="ss"> </span><span class="ch">\n</span><span class="ss">Testing labels count: </span><span class="sc">{</span><span class="bu">len</span>(test_targets)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(np.random.choice(np.array(train_targets),<span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Training labels count: 60000 
Testing labels count: 10000
[2 3 8 5 7]</code></pre>
</div>
</div>
<p>Now let’s define our custom image <code>Dataset</code> class.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-01-24T05:45:14.705084Z&quot;,&quot;start_time&quot;:&quot;2023-01-24T05:45:14.702344Z&quot;}" data-execution_count="10">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ImageDataset(Dataset):</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, X, y):</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.img_paths <span class="op">=</span> X</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.targets  <span class="op">=</span> y</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>): </span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.img_paths)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, idx):</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>        current_sample <span class="op">=</span> torch.tensor(np.array(Image.<span class="bu">open</span>(<span class="va">self</span>.img_paths[idx]))).flatten()<span class="op">/</span><span class="fl">255.</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>        current_target <span class="op">=</span> <span class="va">self</span>.targets[idx]</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>            current_sample, </span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>            current_target</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>        )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As we can see above, <code>ImageDataset</code> is a custom PyTorch <code>Dataset</code> class. Let’s walk through the components -</p>
<ul>
<li>The class takes two inputs in its constructor, <code>X</code> and <code>y</code>, which are lists of image file paths and corresponding labels respectively. These are stored as class variables <code>self.img_paths</code> and <code>self.targets</code>.</li>
<li>The <code>__len__</code> method returns the number of images in the dataset by returning the length of <code>self.img_paths</code> list.</li>
<li>The <code>__getitem__</code> method is called when a specific sample is requested from the dataset. It takes an index as an argument, and returns a tuple of the image data and the corresponding label for that index. The image is processed as follows -
<ul>
<li>It opens the image file at the index passed in the argument using PIL(Python Imaging Library) <code>Image.open</code> function</li>
<li>Converts it to a numpy array</li>
<li>Flattens it (convert it from 28x28 2d array to 784 1-d array)</li>
<li>Normalizes it by dividing by 255 floating number</li>
</ul></li>
</ul>
<p>We will now proceed to instantiate our <code>ImageDataset</code> class for both the<code>training</code> and <code>testing</code> datasets</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-01-24T05:45:17.404396Z&quot;,&quot;start_time&quot;:&quot;2023-01-24T05:45:17.374082Z&quot;}" data-execution_count="12">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>train_ds <span class="op">=</span> ImageDataset(X<span class="op">=</span>train_paths, y<span class="op">=</span>train_targets)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>test_ds <span class="op">=</span> ImageDataset(X<span class="op">=</span>test_paths, y<span class="op">=</span>test_targets)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'One object: Image Tensor of shape </span><span class="sc">{</span>train_ds[<span class="dv">0</span>][<span class="dv">0</span>]<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">, Label: </span><span class="sc">{</span>train_ds[<span class="dv">0</span>][<span class="dv">1</span>]<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'One object: Image Tensor of shape </span><span class="sc">{</span>train_ds[<span class="dv">20000</span>][<span class="dv">0</span>]<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">, Label: </span><span class="sc">{</span>train_ds[<span class="dv">20000</span>][<span class="dv">1</span>]<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>One object: Image Tensor of shape torch.Size([784]), Label: 0
One object: Image Tensor of shape torch.Size([784]), Label: 3</code></pre>
</div>
</div>
</section>
<section id="using-torchvision" class="level3" data-number="8.2.2">
<h3 data-number="8.2.2" class="anchored" data-anchor-id="using-torchvision"><span class="header-section-number">8.2.2</span> Using Torchvision</h3>
<p>We have demonstrated the procedure of creating a custom <code>ImageDataset</code> object. Now we will examine how to simplify this process by utilizing the <code>torchvision</code> package. The <code>torchvision</code> package encompasses commonly used datasets, model architectures, and image transformations for computer vision tasks.</p>
<p>To begin, we will import the <code>datasets</code> and <code>transforms</code> modules from the <code>torchvision</code> package.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-01-24T05:45:20.675215Z&quot;,&quot;start_time&quot;:&quot;2023-01-24T05:45:20.542041Z&quot;}" data-execution_count="13">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision <span class="im">import</span> datasets</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision <span class="im">import</span> transforms</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm.auto <span class="im">import</span> tqdm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next we will use <code>datasets</code> and <code>transform</code> modules to load our MNIST images.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-01-24T05:45:21.674477Z&quot;,&quot;start_time&quot;:&quot;2023-01-24T05:45:21.434072Z&quot;}" data-scrolled="true" data-execution_count="14">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>transform <span class="op">=</span> transforms.Compose([</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    transforms.Grayscale(),</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    transforms.ToTensor(), </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    transforms.Lambda(<span class="kw">lambda</span> x: torch.flatten(x))</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co">## Create a dataset</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>train_ds <span class="op">=</span> datasets.ImageFolder(root <span class="op">=</span> dPath<span class="op">/</span><span class="st">'training/'</span>, </span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>                                      transform<span class="op">=</span>transform)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>test_ds <span class="op">=</span> datasets.ImageFolder(root<span class="op">=</span>dPath<span class="op">/</span><span class="st">'testing'</span>, transform<span class="op">=</span>transform)</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Length of train dataset: </span><span class="sc">{</span><span class="bu">len</span>(train_ds)<span class="sc">}</span><span class="ss">, test_dataset: </span><span class="sc">{</span><span class="bu">len</span>(test_ds)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'One object: Image Tensor of shape </span><span class="sc">{</span>train_ds[<span class="dv">0</span>][<span class="dv">0</span>]<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">, Label: </span><span class="sc">{</span>train_ds[<span class="dv">0</span>][<span class="dv">1</span>]<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Length of train dataset: 60000, test_dataset: 10000
One object: Image Tensor of shape torch.Size([784]), Label: 0</code></pre>
</div>
</div>
<p>Let’s look at the code above:</p>
<p>The first step is to define a <code>transform</code> object using the <code>transforms.Compose</code> function. This function takes a list of transformation functions as an argument and applies them in the order they are passed in. In this case, the following transformations are applied:</p>
<ul>
<li><code>transforms.Grayscale()</code>: Convert the images to grayscale</li>
<li><code>transforms.ToTensor()</code>: Converts the images to PyTorch tensors</li>
<li><code>transforms.Lambda(lambda x: torch.flatten(x))</code>: Flatten the tensors from 28x28 2-D arrayto 784 1-D array</li>
</ul>
<p>Next, it creates two datasets for training and testing using the <code>datasets.ImageFolder</code> class. It takes the root directory of the dataset and the transform object as the arguments. It automatically creates a label for each image by taking the name of the folder where the image is stored.</p>
<p>The code then prints the length of the train and test datasets and the shape and label of the first object in the train dataset. The <code>datasets.ImageFolder</code> class is a convenient way to create a Pytorch dataset from a directory of images and it is useful when you have the data in a structured way.</p>
</section>
</section>
<section id="create-a-dataloader" class="level2" data-number="8.3">
<h2 data-number="8.3" class="anchored" data-anchor-id="create-a-dataloader"><span class="header-section-number">8.3</span> Create a Dataloader</h2>
<p>Create a dataloader using <code>torch.utils.data.DataLoader</code> function.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-01-24T05:45:23.961042Z&quot;,&quot;start_time&quot;:&quot;2023-01-24T05:45:23.958508Z&quot;}" data-execution_count="15">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>num_workers <span class="op">=</span> <span class="bu">int</span>(os.cpu_count()<span class="op">/</span><span class="dv">2</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>train_dls <span class="op">=</span> torch.utils.data.DataLoader(train_ds, batch_size<span class="op">=</span><span class="dv">128</span>, shuffle<span class="op">=</span><span class="va">True</span>, num_workers<span class="op">=</span>num_workers)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>test_dls <span class="op">=</span> torch.utils.data.DataLoader(test_ds, batch_size<span class="op">=</span><span class="dv">128</span>, shuffle<span class="op">=</span><span class="va">False</span>, num_workers<span class="op">=</span>num_workers)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>torch.utils.data.DataLoader</code> class takes a <code>dataset</code> object as an argument and returns an iterator over the <code>dataset</code> object. It can be used to load the data in batches, shuffle the data, and apply other useful functionality.</p>
<p>In the above code, following parameters are passed to the <code>DataLoader</code>:</p>
<ul>
<li><code>train_ds</code> and <code>test_ds</code> are the training and testing datasets respectively.</li>
<li><code>batch_size=128</code>: The number of samples per batch.</li>
<li><code>shuffle=True</code> for the training dataset, and <code>shuffle=False</code> for the testing dataset: whether to shuffle the data before iterating through it.</li>
<li><code>num_workers=num_workers</code>: the number of worker threads to use for loading the data. Here it is set to half of the number of CPU cores using <code>os.cpu_count()</code> method.</li>
</ul>
<p>It returns two data loaders, one for the training dataset and one for the testing dataset. The data loaders can be used as iterators to access the data in batches. This allows to load the data in smaller chunks, making it more memory efficient and faster to train.</p>
<p>Let’s look at one batch.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-01-24T05:45:26.227413Z&quot;,&quot;start_time&quot;:&quot;2023-01-24T05:45:25.194007Z&quot;}" data-execution_count="16">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>batch <span class="op">=</span> <span class="bu">next</span>(<span class="bu">iter</span>(train_dls))</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>batch[<span class="dv">0</span>].shape, batch[<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>(torch.Size([128, 784]),
 tensor([5, 4, 1, 5, 7, 5, 4, 7, 2, 1, 5, 7, 6, 5, 8, 6, 3, 7, 8, 0, 4, 4, 4, 0,
         6, 7, 1, 4, 0, 6, 3, 9, 1, 0, 1, 9, 4, 1, 0, 1, 9, 3, 8, 2, 6, 2, 1, 2,
         1, 0, 2, 4, 7, 4, 7, 3, 3, 4, 3, 3, 4, 4, 7, 3, 3, 4, 6, 5, 1, 0, 2, 3,
         0, 4, 5, 7, 1, 5, 0, 1, 1, 3, 0, 0, 1, 4, 0, 6, 2, 3, 8, 1, 8, 1, 2, 5,
         5, 8, 9, 9, 9, 3, 1, 1, 3, 4, 1, 7, 8, 0, 1, 1, 2, 9, 1, 5, 3, 4, 0, 6,
         1, 4, 0, 8, 9, 1, 7, 4]))</code></pre>
</div>
</div>
<p>As we can observe, each batch comprises of an input tensor of shape <code>(128x784)</code> representing 128 images of flattened <code>(28x28)</code> dimension, and a label tensor of shape <code>(128)</code> representing the corresponding digit labels for the images.</p>
</section>
<section id="defining-our-training-and-validation-loops" class="level2" data-number="8.4">
<h2 data-number="8.4" class="anchored" data-anchor-id="defining-our-training-and-validation-loops"><span class="header-section-number">8.4</span> Defining our Training and Validation loops</h2>
<p>We will now implement the training loop. It is similar to the training loop we constructed in chapter 6.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-01-24T05:45:27.758169Z&quot;,&quot;start_time&quot;:&quot;2023-01-24T05:45:27.754566Z&quot;}" data-execution_count="17">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Training loop</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_one_epoch(model, data_loader, optimizer, loss_func):</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    total_loss, nums <span class="op">=</span> <span class="dv">0</span>, <span class="dv">0</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> batch <span class="kw">in</span> tqdm(<span class="bu">iter</span>(data_loader)):</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">## Taking one mini-batch</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>        xb, yb <span class="op">=</span> batch[<span class="dv">0</span>].to(dev), batch[<span class="dv">1</span>].to(dev)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> model.forward(xb)</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">## Calculation mean square error per min-batch</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>        nums <span class="op">+=</span> <span class="bu">len</span>(yb)</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>        loss <span class="op">=</span> loss_func(y_pred, yb)</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>        total_loss <span class="op">+=</span> loss.item() <span class="op">*</span> <span class="bu">len</span>(yb)</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">## Computing gradients per mini-batch</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>        loss.backward()</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">## Update model parameters and zero grad</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>        optimizer.step()</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>        optimizer.zero_grad()</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>  total_loss <span class="op">/</span> nums</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>        </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The train_one_epoch function takes 4 arguments:</p>
<ul>
<li><code>model</code>: The model to be trained</li>
<li><code>data_loader</code>: The data loader for the training dataset</li>
<li><code>optimizer</code>: The optimizer used to update the model parameters</li>
<li><code>loss_func</code>: The loss function used to calculate the error of the model</li>
</ul>
<p>The function uses a for loop to iterate through the data loader. For each mini-batch of data, it performs the following steps:</p>
<ul>
<li>It loads the data and the labels from the data loader and sends it to the device.</li>
<li>It makes a forward pass through the model to get the predictions and then calculates the loss using the loss function.</li>
<li>It computes the gradients of the model parameters with respect to the loss.</li>
<li>It updates the model parameters using the optimizer and zero the gradients.</li>
<li>The total_loss and nums variables are used to keep track of the total loss and number of samples seen during the epoch.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> validate_one_epoch(model, data_loader, loss_func):</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    loss, nums, acc <span class="op">=</span> <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> batch <span class="kw">in</span> tqdm(<span class="bu">iter</span>(data_loader)):</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>            xb, yb <span class="op">=</span> batch[<span class="dv">0</span>].to(dev), batch[<span class="dv">1</span>].to(dev)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>            y_pred <span class="op">=</span> model.forward(xb)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>            nums <span class="op">+=</span> <span class="bu">len</span>(yb)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">+=</span> loss_func(y_pred, yb).item() <span class="op">*</span> <span class="bu">len</span>(yb)</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>            acc <span class="op">+=</span> <span class="bu">sum</span>(y_pred.argmax(axis<span class="op">=</span><span class="dv">1</span>) <span class="op">==</span> yb).item()</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> loss<span class="op">/</span>nums, acc<span class="op">/</span>nums</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The validate_one_epoch function takes 3 arguments:</p>
<ul>
<li><code>model</code>: The model to be validated</li>
<li><code>data_loader</code>: The data loader for the validation dataset</li>
<li><code>loss_func</code>: The loss function used to calculate the error of the model</li>
</ul>
<p>This function also uses a for loop to iterate through the data loader. For each mini-batch of data, it performs the following steps:</p>
<ul>
<li>It loads the data and the labels from the data loader and sends it to the device.</li>
<li>It makes a forward pass through the model to get the predictions and then calculates the loss using the loss function.</li>
<li>It compares the predictions to the labels to calculate the accuracy.</li>
<li>The loss, nums, and acc variables are used to keep track of the total loss, number of samples seen during the epoch and accuracy respectively.</li>
</ul>
</section>
<section id="training-using-a-fully-connected-multi-layer-perceptron-model" class="level2" data-number="8.5">
<h2 data-number="8.5" class="anchored" data-anchor-id="training-using-a-fully-connected-multi-layer-perceptron-model"><span class="header-section-number">8.5</span> Training using a Fully Connected/ Multi Layer Perceptron Model</h2>
<p>Let’s define our model.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-01-24T05:45:30.405209Z&quot;,&quot;start_time&quot;:&quot;2023-01-24T05:45:30.402617Z&quot;}" data-execution_count="18">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MLP(nn.Module):</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, n_in, n_out):</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model <span class="op">=</span> nn.Sequential(</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>            nn.Linear(n_in, <span class="dv">256</span>),</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="dv">256</span>, <span class="dv">128</span>),</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="dv">128</span>, n_out)</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.model(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The code above defines an <code>MLP</code> model as a Pytorch <code>nn.Module</code> class. The class takes in two arguments, <code>n_in</code> and <code>n_out</code> which represents the number of input features and the number of output features of the model respectively. The class is a simple Multi-layer Perceptron model with 3 hidden layers. Each hidden layer have a linear layer with a <code>ReLU</code> activation function. The forward method takes in input tensor <code>x</code> and returns the output by passing it through the defined sequential model.</p>
<p>Let’s define our training parameters.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-01-24T05:45:33.361964Z&quot;,&quot;start_time&quot;:&quot;2023-01-24T05:45:32.141944Z&quot;}" data-execution_count="19">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>dev <span class="op">=</span> torch.device(<span class="st">"cuda"</span>) <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> torch.device(<span class="st">"cpu"</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>loss_func <span class="op">=</span> nn.CrossEntropyLoss()</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> MLP(<span class="dv">784</span>,<span class="dv">10</span>).to(dev)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> torch.optim.SGD(model.parameters(), lr<span class="op">=</span><span class="fl">1e-3</span>)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>epochs <span class="op">=</span> <span class="dv">5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This code is preparing the <code>model</code>, <code>loss function</code>, <code>optimizer</code>, and the number of training <code>epochs</code> to train the MLP model.</p>
<ul>
<li><code>dev = torch.device("cuda") if torch.cuda.is_available() else torch.device("cpu")</code>: This line of code is determining which device to use for training. If a CUDA-enabled GPU is available, the model and data will be moved to the GPU for faster training, otherwise it will use the CPU.</li>
<li><code>loss_func = nn.CrossEntropyLoss()</code>: This line of code is defining the loss function for the model. CrossEntropyLoss is a commonly used loss function for multi-class classification problems.</li>
<li><code>model = MLP(784,10).to(dev)</code>: This line of code is instantiating the MLP model with 784 input features and 10 output features, and then moving it to the device.</li>
<li><code>optimizer = torch.optim.SGD(model.parameters(), lr=1e-3)</code>: This line of code is creating an optimizer with Stochastic Gradient Descent (SGD) algorithm and a learning rate of 1e-3. The optimizer updates the model parameters during training to minimize the loss function.</li>
<li><code>epochs = 5</code>: This line of code is specifying the number of training epochs. An epoch is one complete pass through the entire training dataset.</li>
</ul>
<p>We will now evaluate the performance of our model on the validation dataset before training.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-01-24T05:45:38.400478Z&quot;,&quot;start_time&quot;:&quot;2023-01-24T05:45:34.726229Z&quot;}" data-execution_count="20">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>test_loss, test_acc <span class="op">=</span> validate_one_epoch(model<span class="op">=</span>model, data_loader<span class="op">=</span>test_dls, loss_func<span class="op">=</span>loss_func)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Random model: Test Loss: </span><span class="sc">{</span>test_loss<span class="sc">:.4f}</span><span class="ss">, Test Accuracy: </span><span class="sc">{</span>test_acc<span class="sc">:.4f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"cf87e70319a640b5a62df1559b40918d","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Random model: Test Loss: 2.3025, Test Accuracy: 0.0772</code></pre>
</div>
</div>
<p>As anticipated, the model’s accuracy is low, around 7-8%, due to the fact that it has not been trained yet.</p>
<p>We will now encapsulate our previously defined functions in a <code>fit</code> function, which will be responsible for both training and evaluating the model.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-01-24T05:45:40.345099Z&quot;,&quot;start_time&quot;:&quot;2023-01-24T05:45:40.342384Z&quot;}" data-execution_count="21">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fit(epochs, model, loss_func, opt, train_dls, valid_dls):</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>):    </span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>        train_loss <span class="op">=</span> train_one_epoch(model<span class="op">=</span>model, data_loader<span class="op">=</span>train_dls, optimizer<span class="op">=</span>optimizer, loss_func<span class="op">=</span>loss_func)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>        test_loss, test_acc <span class="op">=</span> validate_one_epoch(model<span class="op">=</span>model, data_loader<span class="op">=</span>valid_dls, loss_func<span class="op">=</span>loss_func)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Epoch </span><span class="sc">{</span>epoch<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">,Train Loss: </span><span class="sc">{</span>train_loss<span class="sc">:.4f}</span><span class="ss">, Test Loss: </span><span class="sc">{</span>test_loss<span class="sc">:.4f}</span><span class="ss">, Valid Accuracy: </span><span class="sc">{</span>test_acc<span class="sc">:.4f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>fit</code> function uses a for loop to iterate over the number of training <code>epochs</code>. In each iteration, it calls the following functions:</p>
<ul>
<li><code>train_one_epoch</code>: It trains the model for one epoch using the training data and optimizer.</li>
<li><code>validate_one_epoch</code>: It evaluates the model on the validation dataset and returns the loss and accuracy.</li>
</ul>
<p>It prints the training loss, validation loss and validation accuracy for each epoch. Let’s use the <code>fit</code> function to train our model.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-01-24T05:47:49.037513Z&quot;,&quot;start_time&quot;:&quot;2023-01-24T05:45:43.514602Z&quot;}" data-execution_count="22">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>fit(epochs, model, loss_func, optimizer, train_dls, test_dls)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"0c5eec6a13d749159ed8425b3527e94e","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"201aa935fe004ac38a76e48d36fc9c05","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 1,Train Loss: 2.2945, Test Loss: 2.2852, Valid Accuracy: 0.1614</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"cb65821ab873440c8a6fdd241aec82d7","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"1ffc2c4538ea40f7b1581818c848b8a9","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 2,Train Loss: 2.2770, Test Loss: 2.2659, Valid Accuracy: 0.2339</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"c87a36af281041caaa8988942ea31148","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"796dcb3eccd743c59e90a4f5392ff873","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 3,Train Loss: 2.2564, Test Loss: 2.2426, Valid Accuracy: 0.3347</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"a5f205fd4d9e4df28945ba9ba017387f","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"a8a24f7b57b84499a1f0c9d9d30f1c67","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 4,Train Loss: 2.2310, Test Loss: 2.2131, Valid Accuracy: 0.4615</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"9be0806ca9214b798085eea68bc4df21","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"3ba2d46c9502427e9350c14fd49114e9","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 5,Train Loss: 2.1983, Test Loss: 2.1752, Valid Accuracy: 0.5695</code></pre>
</div>
</div>
<p>As we can observe, the model is training effectively and we were able to increase the accuracy from 7-8% to 57% by training for only five epochs.</p>
<p>Now, we will replace the optimizer in our <code>fit</code>function to the <code>AdamW</code> optimizer from the <code>torch.optim</code> module, and rerun the <code>fit</code> function.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-01-24T05:50:29.838438Z&quot;,&quot;start_time&quot;:&quot;2023-01-24T05:48:28.865153Z&quot;}" data-execution_count="23">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> MLP(<span class="dv">784</span>,<span class="dv">10</span>).to(dev)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> torch.optim.AdamW(model.parameters(), lr<span class="op">=</span><span class="fl">1e-3</span>)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>fit(epochs, model, loss_func, optimizer, train_dls, test_dls)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"db99533f23c3485b83ca6a6cd7bf93f3","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"5eaf45cf702840e6916cbab4b8983d87","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 1,Train Loss: 0.3480, Test Loss: 0.1660, Valid Accuracy: 0.9501</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"789f236d6f164d19991e6d1fee71a2e8","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"560f9859321c4c74b7c410142d70428d","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 2,Train Loss: 0.1392, Test Loss: 0.1289, Valid Accuracy: 0.9597</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"2bc5d73d71b9401aa59229c282a8d07f","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"2ff1eb9e523e4901b19532c4ca28b6a4","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 3,Train Loss: 0.0895, Test Loss: 0.0931, Valid Accuracy: 0.9699</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"a7ac53a559aa48b39e68786360e947bd","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"480ccd0f8e534bcfa9300a1dffa209b1","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 4,Train Loss: 0.0659, Test Loss: 0.0758, Valid Accuracy: 0.9759</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"cf30719c2b454f8888fd4b6ee3bb7083","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"b3ade4489d03463397bbf7f109ae564f","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 5,Train Loss: 0.0490, Test Loss: 0.0700, Valid Accuracy: 0.9797</code></pre>
</div>
</div>
<p>By utilizing the <code>AdamW</code> optimizer and <code>MLP</code> model, we can see that after 5 epochs, we have a highly accurate model with a 98% accuracy as compared to random prediction of 7-8%.</p>
</section>
<section id="training-using-a-simple-cnn-model" class="level2" data-number="8.6">
<h2 data-number="8.6" class="anchored" data-anchor-id="training-using-a-simple-cnn-model"><span class="header-section-number">8.6</span> Training using a simple CNN model</h2>
<p>As previously demonstrated, the fit function is highly adaptable as we were able to change our optimizer without making any modifications to the function. Now, we will replace our MLP model with a CNN (Convolutional Neural Network) model. We will begin by defining a basic CNN network.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-01-24T05:50:42.399405Z&quot;,&quot;start_time&quot;:&quot;2023-01-24T05:50:42.395935Z&quot;}" data-execution_count="24">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn.functional <span class="im">as</span> F</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Mnist_CNN(nn.Module):</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.conv1 <span class="op">=</span> nn.Conv2d(<span class="dv">1</span>, <span class="dv">16</span>, kernel_size<span class="op">=</span><span class="dv">3</span>, stride<span class="op">=</span><span class="dv">2</span>, padding<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.conv2 <span class="op">=</span> nn.Conv2d(<span class="dv">16</span>, <span class="dv">32</span>, kernel_size<span class="op">=</span><span class="dv">3</span>, stride<span class="op">=</span><span class="dv">2</span>, padding<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.conv3 <span class="op">=</span> nn.Conv2d(<span class="dv">32</span>, <span class="dv">10</span>, kernel_size<span class="op">=</span><span class="dv">3</span>, stride<span class="op">=</span><span class="dv">2</span>, padding<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, xb):</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>        xb <span class="op">=</span> xb.view(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">28</span>, <span class="dv">28</span>)</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>        xb <span class="op">=</span> F.relu(<span class="va">self</span>.conv1(xb))</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>        xb <span class="op">=</span> F.relu(<span class="va">self</span>.conv2(xb))</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>        xb <span class="op">=</span> F.relu(<span class="va">self</span>.conv3(xb))</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>        xb <span class="op">=</span> F.avg_pool2d(xb, <span class="dv">4</span>)</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> xb.view(<span class="op">-</span><span class="dv">1</span>, xb.size(<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The code above defines a class called <code>Mnist_CNN</code> which is a subclass of <code>nn.Module</code>. It creates an object of the class and initiates three 2D convolutional layers(<code>conv1</code>, <code>conv2</code>, <code>conv3</code>) with different input and output channels, kernel size, stride and padding. The forward method applies the convolution operation on the input tensor with <code>relu</code> activation function, then average pooling is applied to the output tensor and the final output tensor is reshaped to a 1-D tensor.</p>
<p>Now, we can pass an instance of this model to the <code>fit</code> function for training and validation.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-01-24T05:52:43.227736Z&quot;,&quot;start_time&quot;:&quot;2023-01-24T05:50:43.547646Z&quot;}" data-execution_count="25">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Mnist_CNN().to(dev)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> torch.optim.AdamW(model.parameters(), lr<span class="op">=</span><span class="fl">1e-3</span>)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>fit(epochs, model, loss_func, optimizer, train_dls, test_dls)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d01ea524e9664e77abc332b6c573d45d","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"368c945206c249e4ae197fa845c02585","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 1,Train Loss: 1.8228, Test Loss: 1.4976, Valid Accuracy: 0.5442</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"854ef758af2546979aa757712c3270e3","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"4a7c1cefbd5e4be2973d2153a730fa05","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 2,Train Loss: 1.3562, Test Loss: 1.2602, Valid Accuracy: 0.5958</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"392814c079304ab1a2aae65045be5330","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d8014c371ea24de681c8f4e177f5d3d2","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 3,Train Loss: 1.2113, Test Loss: 1.1522, Valid Accuracy: 0.6144</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d43bbc4cf39a4c0bb341aca7739463df","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"23c6871cc6e6418f89dd7d01765716b2","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 4,Train Loss: 1.1286, Test Loss: 1.0886, Valid Accuracy: 0.6187</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"98da5a25e87b4cb9932449c899393dca","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6f23b1f9907b4245944445f118e76fcb","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 5,Train Loss: 1.0741, Test Loss: 1.0454, Valid Accuracy: 0.6308</code></pre>
</div>
</div>
<p>As can be observed, we are able to seamlessly switch from an MLP to a CNN model by utilizing the adaptable <code>fit</code> function and train the model.</p>
</section>
<section id="conclusion" class="level2" data-number="8.7">
<h2 data-number="8.7" class="anchored" data-anchor-id="conclusion"><span class="header-section-number">8.7</span> Conclusion</h2>
<p>In this chapter, we progressed from a basic linear regression example to building an image classifier using MLP and CNN models. We gained practical experience in creating custom <code>Dataset</code> and <code>Dataloader</code> objects and were introduced to the <code>torchvision</code> library for simplifying this process. Additionally, we developed a versatile <code>fit</code> function, which can be utilized with various models, optimizers, and loss functions for training our models.</p>
<p>The idea of flexibility as demonstrated in the <code>fit</code> function is not unique, and there are many frameworks that aim to simplify the model training process by offering high-level APIs, allowing machine learning scientists to focus on building and solving problems, while the frameworks handle the majority of the complexity. In the next chapter, we will repeat the same exercise using the <a href="https://docs.fast.ai/"><code>fastai</code></a> library, which is a highly flexible and performant framework built on top of PyTorch, and observe how we can construct neural networks with minimal lines of code.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../basics/7_models.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Model building</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../basics/9_NeuralNetworkWithFastAI.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Neural Networks with fastai (draft)</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">The PyTorch book. Copyright (c) 2022 Aayush Agrawal.</div>   
    <div class="nav-footer-right">This book was built with <a href="https://quarto.org/">Quarto</a></div>
  </div>
</footer>



</body></html>